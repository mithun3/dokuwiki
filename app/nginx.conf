user  www-data;
worker_processes  auto;

error_log  /dev/stderr info;
pid        /run/nginx.pid;

events {
    worker_connections  1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    access_log    /dev/stdout;
    sendfile      on;
    keepalive_timeout  65;
    client_max_body_size 64m;

    server {
        listen 80 default_server;
        server_name _;
        root /var/www/dokuwiki;
        index doku.php index.php index.html;

        # Pretty URLs for DokuWiki
        location / {
            try_files $uri $uri/ @dokuwiki;
        }

        location @dokuwiki {
            rewrite ^/_media/(.*) /lib/exe/fetch.php?media=$1 last;
            rewrite ^/_detail/(.*) /lib/exe/detail.php?media=$1 last;
            rewrite ^/_export/([^/]+)/(.*) /doku.php?do=export_$1&id=$2 last;
            rewrite ^/(.*) /doku.php?id=$1 last;
        }

        location ~ \.php$ {
            include        fastcgi_params;
            fastcgi_pass   127.0.0.1:9000;
            fastcgi_index  doku.php;
            fastcgi_param  SCRIPT_FILENAME $document_root$fastcgi_script_name;
            fastcgi_buffer_size 32k;
            fastcgi_buffers 8 16k;
        }

        # Protect internal DokuWiki paths
        location ~ /(data|conf|bin|inc)/ {
            deny all;
            return 403;
        }
    }
}
