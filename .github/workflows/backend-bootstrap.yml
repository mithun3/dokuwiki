name: Terraform Backend Bootstrap

# One-time setup workflow for Terraform remote state backend:
#   - bootstrap: Creates S3 bucket and DynamoDB table for state storage/locking
#
# Run this once before any other Terraform workflows.
# Manual trigger only (workflow_dispatch).

on:
  workflow_dispatch:
    inputs:
      state_bucket:
        description: "S3 bucket name for Terraform state"
        type: choice
        options:
          - "dokuwiki-tfstate-bucket"
      state_key:
        description: "Object key for the state file"
        type: choice
        options:
          - "dokuwiki/terraform.tfstate"
      lock_table:
        description: "DynamoDB table name for state locking"
        type: choice
        options:
          - "tf-locks"
      aws_region:
        description: "AWS region (fixed)"
        type: choice
        options:
          - "ap-southeast-2"
      project_name:
        description: "Project tag for backend stack"
        type: choice
        options:
          - "dokuwiki"

permissions:
  id-token: write
  contents: read

jobs:
  bootstrap:
    runs-on: ubuntu-latest
    env:
      AWS_REGION: ${{ inputs.aws_region }}
      STATE_BUCKET: ${{ inputs.state_bucket }}
      STATE_KEY: ${{ inputs.state_key }}
      LOCK_TABLE: ${{ inputs.lock_table }}
      PROJECT: ${{ inputs.project_name }}
      TF_IN_AUTOMATION: "true"
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_BACKEND_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - name: Bootstrap remote backend (S3 + DynamoDB)
        run: ./scripts/tf-backend-bootstrap.sh
