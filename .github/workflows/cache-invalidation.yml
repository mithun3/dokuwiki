name: Clear Cache Post-Deploy

on:
  workflow_run:
    workflows: ["Deploy to ECS"]
    types:
      - completed
    branches:
      - main

permissions:
  contents: read

jobs:
  clear-cache:
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Wait for ECS task to be stable
        run: |
          CLUSTER="${{ secrets.ECS_CLUSTER_NAME }}"
          SERVICE="${{ secrets.ECS_SERVICE_NAME }}"
          echo "Waiting for ECS service to reach steady state..."
          aws ecs wait services-stable --cluster "$CLUSTER" --services "$SERVICE"
          echo "✓ Service is stable"

      - name: Get task ID
        id: task
        run: |
          CLUSTER="${{ secrets.ECS_CLUSTER_NAME }}"
          SERVICE="${{ secrets.ECS_SERVICE_NAME }}"
          TASK_ARN=$(aws ecs list-tasks \
            --cluster "$CLUSTER" \
            --service-name "$SERVICE" \
            --desired-status RUNNING \
            --query 'taskArns[0]' \
            --output text)
          echo "task_arn=$TASK_ARN" >> "$GITHUB_OUTPUT"
          echo "Task ARN: $TASK_ARN"

      - name: Clear cache in running task
        run: |
          CLUSTER="${{ secrets.ECS_CLUSTER_NAME }}"
          TASK_ARN="${{ steps.task.outputs.task_arn }}"
          CONTAINER_NAME="${{ secrets.ECS_CONTAINER_NAME }}"
          
          if [ -z "$TASK_ARN" ] || [ "$TASK_ARN" = "None" ]; then
            echo "⚠️  No running tasks found, skipping cache clear"
            exit 0
          fi
          
          echo "Executing cache clear in ECS task: $TASK_ARN"
          
          aws ecs execute-command \
            --cluster "$CLUSTER" \
            --task "$TASK_ARN" \
            --container "$CONTAINER_NAME" \
            --interactive \
            --command "/bin/sh -c 'rm -rf /var/www/dokuwiki/data/cache/* && rm -rf /var/www/dokuwiki/data/index/* && rm -rf /var/www/dokuwiki/data/tmp/* && echo \"✓ Cache cleared\"'"
          
          echo "✓ Cache clear command sent"

      - name: Verify cache clear
        run: |
          echo "Cache invalidation complete - fresh pages will be served on next request"
